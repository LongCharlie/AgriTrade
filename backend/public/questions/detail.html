<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—®é¢˜è¯¦æƒ…</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .question-detail {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .question-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .question-content {
            margin-bottom: 15px;
            line-height: 1.6;
        }
        .question-meta {
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            color: white;
        }
        .status-pending {
            background-color: #f39c12;
        }
        .status-answered {
            background-color: #2ecc71;
        }
        .status-closed {
            background-color: #95a5a6;
        }
        .actions {
            margin-top: 20px;
        }
        button {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        button.close {
            background: #e74c3c;
        }
        .error {
            color: red;
        }
        /* æ–°å¢å›¾ç‰‡å±•ç¤ºåŒºåŸŸæ ·å¼ */
        .question-images {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        .question-image {
            width: 150px;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }
        .question-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .question-image:hover img {
            transform: scale(1.05);
        }
        /* å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            max-width: 90%;
            max-height: 90%;
        }
        .modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
        }
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        .answers-section {
            margin-top: 40px;
        }
        .answers-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .answer-list {
            margin-top: 20px;
        }
        .answer-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        .answer-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .answer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        .answer-meta {
            flex: 1;
        }
        .answer-expert {
            font-weight: bold;
        }
        .answer-title {
            font-size: 0.9em;
            color: #666;
        }
        .answer-date {
            font-size: 0.8em;
            color: #999;
        }
        .answer-content {
            line-height: 1.6;
            margin: 10px 0;
        }
        .answer-actions {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        .upvote-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 3px 10px;
            margin-right: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .upvote-btn:hover {
            background: #f0f0f0;
        }
        .upvote-count {
            margin-left: 5px;
        }
        
        .delete {
    background: #e74c3c;
}
.delete:hover {
    background: #c0392b;
}

.admin-action {
    background: #9b59b6;
}
.admin-action:hover {
    background: #8e44ad;
}

        /* å›ç­”è¡¨å•æ ·å¼ */
        .answer-form {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            background: #f5f5f5;
        }
        .answer-form h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .answer-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            resize: vertical;
        }
        .answer-form button {
            background: #3498db;
        }
        .answer-form button:hover {
            background: #2980b9;
        }
    </style>
    <script src="/js/auth.js"></script>
</head>
<body>
    <h1>é—®é¢˜è¯¦æƒ…</h1>
    <a href="/questions/list.html">è¿”å›é—®é¢˜åˆ—è¡¨</a>
    
    <div id="questionDetail" class="question-detail">
        <p>åŠ è½½ä¸­...</p>
    </div>
    
    <div class="actions" id="actions" >
    <button id="closeBtn" class="close">å…³é—­é—®é¢˜</button>
    <button id="deleteQuestionBtn" class="delete" style="background: #e74c3c; display: none;">åˆ é™¤é—®é¢˜</button>
</div>
    
    <div id="error" class="error"></div>
    
    <!-- å›ç­”åŒºåŸŸ -->
    <div class="answers-section">
        <div class="answers-title">å›ç­”</div>
        <div id="answerList" class="answer-list">
            <!-- å›ç­”å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
        
        <!-- ä¸“å®¶å›ç­”è¡¨å• (ä»…ä¸“å®¶å¯è§) -->
        <div id="answerForm" class="answer-form" data-role="expert">
            <h3>å›ç­”é—®é¢˜</h3>
            <textarea id="answerContent" placeholder="è¯·è¾“å…¥æ‚¨çš„å›ç­”..."></textarea>
            <button id="submitAnswer">æäº¤å›ç­”</button>
        </div>
    </div>
    
    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="imageModal" class="modal">
        <span class="close-modal" onclick="closeModal()">Ã—</span>
        <div class="modal-content">
            <img id="modalImage" src="">
        </div>
    </div>
    
    <script>
        // å…¨å±€å˜é‡å­˜å‚¨å½“å‰é—®é¢˜ID
        let currentQuestionId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            currentQuestionId = urlParams.get('id');
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            if (currentUser && currentUser.role === 'admin') {
                document.getElementById('deleteQuestionBtn').style.display = 'inline-block';
            }

            if (!currentQuestionId) {
                document.getElementById('error').textContent = 'æœªæŒ‡å®šé—®é¢˜ID';
                return;
            }
            
            try {
                // åŠ è½½é—®é¢˜è¯¦æƒ…
                await loadQuestionDetail();
                
                // åŠ è½½å›ç­”åˆ—è¡¨
                await loadAnswers();
                
                // å¦‚æœæ˜¯ä¸“å®¶ä¸”é—®é¢˜çŠ¶æ€æ˜¯pendingï¼Œæ˜¾ç¤ºå›ç­”è¡¨å•
                if (currentUser && currentUser.role === 'expert') {
                    const question = await apiRequest(`/api/questions/${currentQuestionId}`);
                    if (question.status === 'pending') {
                        document.getElementById('answerForm').style.display = 'block';
                    }
                }
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        });
                

        // æ·»åŠ ç®¡ç†å‘˜åˆ é™¤é—®é¢˜çš„å‡½æ•°
document.getElementById('deleteQuestionBtn')?.addEventListener('click', async function() {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé—®é¢˜å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤æ‰€æœ‰ç›¸å…³å›ç­”å’Œå›¾ç‰‡ï¼Œä¸”ä¸å¯æ¢å¤ã€‚')) {
        return;
    }
    
    try {
        await apiRequest(`/api/questions/${currentQuestionId}`, 'DELETE');
        alert('é—®é¢˜åˆ é™¤æˆåŠŸ');
        window.location.href = '/questions/list.html';
    } catch (error) {
        document.getElementById('error').textContent = error.message;
    }
});

// æ·»åŠ ç®¡ç†å‘˜åˆ é™¤å›ç­”çš„å‡½æ•°
window.adminDeleteAnswer = async function(answerId) {
    if (!confirm('ç¡®å®šè¦ä»¥ç®¡ç†å‘˜èº«ä»½åˆ é™¤è¿™ä¸ªå›ç­”å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
    }
    
    try {
        await apiRequest(`/api/answers/${answerId}`, 'DELETE');
        alert('å›ç­”åˆ é™¤æˆåŠŸ');
        await loadAnswers();
        
        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å›ç­”ï¼Œå¦‚æœæ²¡æœ‰ï¼Œæ›´æ–°é—®é¢˜çŠ¶æ€
        const answers = await apiRequest(`/api/questions/${currentQuestionId}/answers`);
        if (answers.length === 0) {
            await loadQuestionDetail();
        }
    } catch (error) {
        document.getElementById('error').textContent = error.message;
    }
};
                // åŠ è½½é—®é¢˜è¯¦æƒ…
        async function loadQuestionDetail() {
            const question = await apiRequest(`/api/questions/${currentQuestionId}`);
            
            // æ„å»ºå›¾ç‰‡HTML
            let imagesHtml = '';
            if (question.images && question.images.length > 0) {
                imagesHtml = `
                    <div class="question-images">
                        ${question.images.map(img => `
                            <div class="question-image" onclick="openModal('${img.url}')">
                                <img src="${img.url}" alt="é—®é¢˜å›¾ç‰‡">
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            document.getElementById('questionDetail').innerHTML = `
                <div class="question-title">${question.title}</div>
                <div class="question-content">${question.content}</div>
                ${imagesHtml}
                <div class="question-meta">
                    <span class="status status-${question.status}">${getStatusText(question.status)}</span>
                    Â· åˆ›å»ºäº ${formatDate(question.created_at)}
                </div>
            `;
            
            // å¦‚æœæ˜¯å†œæˆ·ä¸”é—®é¢˜æ˜¯å¼€æ”¾çŠ¶æ€ï¼Œæ˜¾ç¤ºå…³é—­æŒ‰é’®
            if (currentUser && currentUser.role === 'farmer' && question.status === 'pending') {
                document.getElementById('actions').style.display = 'block';
            }
        }
        
        // åŠ è½½å›ç­”åˆ—è¡¨
        async function loadAnswers() {
            const response = await apiRequest(`/api/questions/${currentQuestionId}/answers`);
            const answers = response.answers || [];
            
            if (answers.length === 0) {
                document.getElementById('answerList').innerHTML = '<p>æš‚æ— å›ç­”</p>';
                return;
            }
            
            document.getElementById('answerList').innerHTML = answers.map(answer => `
                <div class="answer-item">
                    <div class="answer-header">
                        <img src="${answer.expert_avatar || '/images/default-avatar.png'}" 
                             alt="${answer.expert_name}" 
                             class="answer-avatar">
                        <div class="answer-meta">
                            <div class="answer-expert">${answer.expert_name || 'åŒ¿åä¸“å®¶'}</div>
                            <div class="answer-title">${answer.expert_title || ''} ${answer.expert_institution || ''}</div>
                        </div>
                        <div class="answer-date">${formatDate(answer.answered_at)}</div>
                    </div>
                    <div class="answer-content">${answer.content}</div>
                    <div class="answer-actions">
    <button class="upvote-btn" onclick="upvoteAnswer(${answer.answer_id})">
        ğŸ‘ <span class="upvote-count">${answer.upvotes || 0}</span>
    </button>
    ${currentUser && currentUser.userId === answer.expert_id ? `
        <button onclick="editAnswer(${answer.answer_id})">ç¼–è¾‘</button>
        <button onclick="deleteAnswer(${answer.answer_id})" style="background: #e74c3c;">åˆ é™¤</button>
    ` : ''}
    ${currentUser && currentUser.role === 'admin' ? `
        <button onclick="adminDeleteAnswer(${answer.answer_id})" style="background: #e74c3c;">ç®¡ç†å‘˜åˆ é™¤</button>
    ` : ''}
</div>
                </div>
            `).join('');
        }

        // æäº¤å›ç­”
        document.getElementById('submitAnswer')?.addEventListener('click', async function() {
            const content = document.getElementById('answerContent').value.trim();
            
            if (!content) {
                alert('å›ç­”å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/questions/${currentQuestionId}/answers`, 'POST', {
                    content: content
                });
                
                alert('å›ç­”æäº¤æˆåŠŸ');
                document.getElementById('answerContent').value = '';
                
                // åˆ·æ–°å›ç­”åˆ—è¡¨
                await loadAnswers();
                
                // åˆ·æ–°é—®é¢˜çŠ¶æ€
                await loadQuestionDetail();
                
                // éšè—å›ç­”è¡¨å•ï¼ˆé—®é¢˜çŠ¶æ€å·²å˜ä¸ºansweredï¼‰
                document.getElementById('answerForm').style.display = 'none';
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        });

        // ç‚¹èµå›ç­”
        window.upvoteAnswer = async function(answerId) {
            try {
                const response = await apiRequest(`/api/answers/${answerId}/upvote`, 'POST');
                
                // æ›´æ–°ç‚¹èµæ•°
                const upvoteBtn = document.querySelector(`.upvote-btn[onclick="upvoteAnswer(${answerId})"]`);
                if (upvoteBtn) {
                    const countSpan = upvoteBtn.querySelector('.upvote-count');
                    if (countSpan) {
                        countSpan.textContent = response.upvotes;
                    }
                }
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        };

        // ç¼–è¾‘å›ç­”
        window.editAnswer = async function(answerId) {
            const answer = await apiRequest(`/api/answers/${answerId}`);
            
            // åˆ›å»ºç¼–è¾‘è¡¨å•
            const editForm = document.createElement('div');
            editForm.className = 'answer-form';
            editForm.innerHTML = `
                <h3>ç¼–è¾‘å›ç­”</h3>
                <textarea id="editAnswerContent">${answer.content}</textarea>
                <button onclick="saveEditAnswer(${answerId})">ä¿å­˜</button>
                <button onclick="cancelEditAnswer(${answerId})" style="background: #95a5a6;">å–æ¶ˆ</button>
            `;
            
            // æ›¿æ¢åŸå›ç­”
            const answerItem = document.querySelector(`.answer-item [onclick="editAnswer(${answerId})"]`).closest('.answer-item');
            answerItem.innerHTML = '';
            answerItem.appendChild(editForm);
        };
        
        // ä¿å­˜ç¼–è¾‘
        window.saveEditAnswer = async function(answerId) {
            const content = document.getElementById('editAnswerContent').value.trim();
            
            if (!content) {
                alert('å›ç­”å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            try {
                await apiRequest(`/api/answers/${answerId}`, 'PATCH', {
                    content: content
                });
                
                // é‡æ–°åŠ è½½å›ç­”åˆ—è¡¨
                await loadAnswers();
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        };

        // å–æ¶ˆç¼–è¾‘
        window.cancelEditAnswer = async function(answerId) {
            // é‡æ–°åŠ è½½å›ç­”åˆ—è¡¨
            await loadAnswers();
        };
        
        // åˆ é™¤å›ç­”
        window.deleteAnswer = async function(answerId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå›ç­”å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await apiRequest(`/api/answers/${answerId}`, 'DELETE');
                
                // é‡æ–°åŠ è½½å›ç­”åˆ—è¡¨
                await loadAnswers();
                
                // å¦‚æœåˆ é™¤çš„æ˜¯æœ€åä¸€ä¸ªå›ç­”ï¼Œå¯èƒ½éœ€è¦æ›´æ–°é—®é¢˜çŠ¶æ€
                await loadQuestionDetail();
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        };

        // å…³é—­é—®é¢˜
        document.getElementById('closeBtn')?.addEventListener('click', async function() {
            try {
                const response = await apiRequest(`/api/questions/${currentQuestionId}/status`, 'PATCH', {
                    status: 'closed'
                });
                
                alert('é—®é¢˜å·²å…³é—­');
                window.location.reload();
            } catch (error) {
                document.getElementById('error').textContent = error.message;
            }
        });

       // æ‰“å¼€å›¾ç‰‡æ¨¡æ€æ¡†
        window.openModal = function(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex';
            modalImg.src = imageUrl;
        };

        // å…³é—­å›¾ç‰‡æ¨¡æ€æ¡†
        window.closeModal = function() {
            document.getElementById('imageModal').style.display = 'none';
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…å›ç­”',
                'answered': 'å·²è§£ç­”',
                'closed': 'å·²å…³é—­'
            };
            return statusMap[status] || status;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    </script>
</body>
</html>
        
        
        
       